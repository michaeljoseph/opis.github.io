<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="keywords" content="Learn how to use transactions">
<title>Transactions | Opis Database</title>
    <link href="/assets/img/favicon.png" rel="shortcut icon">
<link rel="stylesheet" href="/assets/css/flatly-theme.min.css">
<link href="/assets/css/font-awesome.css" rel="stylesheet">
<link href="/assets/css/syntax.css" rel="stylesheet">
<link href="/assets/css/prism-github.css" rel="stylesheet">
<link href="/assets/css/project.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.1.1/gh-fork-ribbon.min.css" />
    <!--[if lt IE 9]>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.1.1/gh-fork-ribbon.ie.min.css" />
    <![endif]-->
    <!--[if lt IE 9]>
<script src="/assets/js/html5shiv.js"></script>
<script src="/assets/js/respond.min.js"></script>
<![endif]-->
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="/assets/js/jquery-1.11.0.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/assets/js/bootstrap.min.js"></script>
<script src="/assets/js/prism.js"></script>
</head>
<body>
    <div class="github-fork-ribbon-wrapper right hidden-sm hidden-xs">
        <div class="github-fork-ribbon" style="background-color: #f80">
            <a href="https://github.com/opis/database">Fork me on GitHub</a>
        </div>
    </div>
    <header id="header" class="navbar navbar-default navbar-static-top">
        <div class="container">
            <div class="navbar-header">
                <img src="/assets/img/opis-gs-100.png" class="img-responsive opis-inline-logo">
                <a href="/database/3.6" class="navbar-brand">
                    <strong>
                        Database
                    </strong>
                </a>
                <button data-target="#navbar-main" data-toggle="collapse" type="button" class="navbar-toggle">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <nav id="navbar-main" class="collapse navbar-collapse navbar-right">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="/" title="Main page">
                            <span class="fa fa-home"></span> Home
                        </a>
                    </li>
                    <li class="dropdown hidden-md hidden-lg">
    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
        <span class="fa fa-file-text"></span> Documentation <span class="caret"></span>
    </a>
    <ul class="dropdown-menu">
            <li class="dropdown-header">Getting started</li>
            <li><a href="/database/3.6/index" title="Getting started with Opis Database">About</a></li>
            <li><a href="/database/3.6/connections" title="Learn how to connect to a database">Database connections</a></li>
            <li class="dropdown-header">The basics</li>
            <li><a href="/database/3.6/fetching-records" title="Fetching records from a database">Fetching records</a></li>
            <li><a href="/database/3.6/results-handling" title="Learn how to handle the result set of a query">Results handling</a></li>
            <li><a href="/database/3.6/aggregate-functions" title="Learn about aggregate functions">Aggregate functions</a></li>
            <li><a href="/database/3.6/extended-selections" title="Learn about how to define custom selections">Extended selections</a></li>
            <li><a href="/database/3.6/filters" title="Learn how to filter records">Filter</a></li>
            <li><a href="/database/3.6/expressions" title="Learn about expressions">Expressions</a></li>
            <li><a href="/database/3.6/ordering-criteria" title="Learn how to order results">Ordering criteria</a></li>
            <li><a href="/database/3.6/limits-and-offsets" title="Learn about limits and offsets">Limits and offset</a></li>
            <li><a href="/database/3.6/joins" title="Learn how to perform joins">Joins</a></li>
            <li><a href="/database/3.6/aggregates-handling" title="Learn how to work with aggregates">Working with aggregates</a></li>
            <li><a href="/database/3.6/insert-records" title="Insert new records into a table">Insert records</a></li>
            <li><a href="/database/3.6/update-records" title="Learn how to update existing records">Update records</a></li>
            <li><a href="/database/3.6/delete-records" title="Learn how to delete existing records">Delete records</a></li>
            <li class="dropdown-header">Transactions</li>
            <li class="active"><a href="/database/3.6/transactions" title="Learn how to use transactions">Performing transactions</a></li>
            <li class="dropdown-header">Database schema</li>
            <li><a href="/database/3.6/schema" title="Learn about Opis Database schema">Introduction</a></li>
            <li><a href="/database/3.6/schema-creating-tables" title="Learn how to create new tables">Creating tables</a></li>
            <li><a href="/database/3.6/schema-modifying-tables" title="Learn how to alter existing new tables">Modifying tables</a></li>
            <li class="dropdown-header">ORM</li>
            <li><a href="/database/3.6/orm" title="Learn about Opis Database ORM">Introduction</a></li>
            <li><a href="/database/3.6/orm-basics" title="Learn how to use Opis Database ORM">Basic operations</a></li>
            <li><a href="/database/3.6/orm-relationships" title="Learn about ORM relationships">Relationships</a></li>
            <li><a href="/database/3.6/orm-models" title="Learn how to work with models">Working with models</a></li>
    </ul>
</li>
                    <li class="dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                            <span class="fa fa-cogs"></span> Components <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a href="/cache/3.1">Cache</a></li>
                            <li><a href="/closure/2.3">Closure</a></li>
                            <li><a href="/config/2.1">Config</a></li>
                            <li><a href="/container/2.3">Container</a></li>
                            <li><a href="/database/3.6">Database</a></li>
                            <li><a href="/events/4.1">Events</a></li>
                            <li><a href="/http/2.0">HTTP</a></li>
                            <li><a href="/http-routing/4.0">HTTP Routing</a></li>
                            <li><a href="/routing/4.1">Routing</a></li>
                            <li><a href="/session/3.1">Session</a></li>
                            <li><a href="/view/4.1">View</a></li>
                        </ul>
                    </li>
                    <li class="hidden-md hidden-lg">
                        <a href="https://github.com/opis/database" title="Github page">
                            <span class="fa fa-github fa-lg"></span> GitHub
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>
    <section>
        <div class="container">
            <div class="row">
                <div class="col-md-4 hidden-xs hidden-sm">
<ul class="navigation">
            <li class="chapter">Getting started</li>
            <ul>
                <li><a href="/database/3.6/index" title="Getting started with Opis Database">About</a></li>
            <li><a href="/database/3.6/connections" title="Learn how to connect to a database">Database connections</a></li>
                </ul>
            <li class="chapter">The basics</li>
            <ul>
                <li><a href="/database/3.6/fetching-records" title="Fetching records from a database">Fetching records</a></li>
            <li><a href="/database/3.6/results-handling" title="Learn how to handle the result set of a query">Results handling</a></li>
            <li><a href="/database/3.6/aggregate-functions" title="Learn about aggregate functions">Aggregate functions</a></li>
            <li><a href="/database/3.6/extended-selections" title="Learn about how to define custom selections">Extended selections</a></li>
            <li><a href="/database/3.6/filters" title="Learn how to filter records">Filter</a></li>
            <li><a href="/database/3.6/expressions" title="Learn about expressions">Expressions</a></li>
            <li><a href="/database/3.6/ordering-criteria" title="Learn how to order results">Ordering criteria</a></li>
            <li><a href="/database/3.6/limits-and-offsets" title="Learn about limits and offsets">Limits and offset</a></li>
            <li><a href="/database/3.6/joins" title="Learn how to perform joins">Joins</a></li>
            <li><a href="/database/3.6/aggregates-handling" title="Learn how to work with aggregates">Working with aggregates</a></li>
            <li><a href="/database/3.6/insert-records" title="Insert new records into a table">Insert records</a></li>
            <li><a href="/database/3.6/update-records" title="Learn how to update existing records">Update records</a></li>
            <li><a href="/database/3.6/delete-records" title="Learn how to delete existing records">Delete records</a></li>
                </ul>
            <li class="chapter">Transactions</li>
            <ul>
                <li class="active"><a href="/database/3.6/transactions" title="Learn how to use transactions">Performing transactions</a></li>
                </ul>
            <li class="chapter">Database schema</li>
            <ul>
                <li><a href="/database/3.6/schema" title="Learn about Opis Database schema">Introduction</a></li>
            <li><a href="/database/3.6/schema-creating-tables" title="Learn how to create new tables">Creating tables</a></li>
            <li><a href="/database/3.6/schema-modifying-tables" title="Learn how to alter existing new tables">Modifying tables</a></li>
                </ul>
            <li class="chapter">ORM</li>
            <ul>
                <li><a href="/database/3.6/orm" title="Learn about Opis Database ORM">Introduction</a></li>
            <li><a href="/database/3.6/orm-basics" title="Learn how to use Opis Database ORM">Basic operations</a></li>
            <li><a href="/database/3.6/orm-relationships" title="Learn about ORM relationships">Relationships</a></li>
            <li><a href="/database/3.6/orm-models" title="Learn how to work with models">Working with models</a></li>
    </ul>
</ul>
                </div>
                <div class="col-md-8 col-sm-12">
                    <h1 id="transactions">Transactions</h1>
<ol>
  <li><a href="#performing-transactions">Performing transactions</a></li>
  <li><a href="#receiving-notifications">Receiving notifications</a></li>
  <li><a href="#ctrling-transaction-s-flow">Controlling transaction’s flow</a></li>
</ol>
<h2 id="performing-transactions">Performing transactions</h2>
<p>Transactions are performed with the help of the <code>transaction</code> and <code>execute</code> methods. 
The result returned from a transaction will be the result returned from the anonymous callback function
that was passed as an argument to the <code>transaction</code> method.</p><pre><code class="language-php">use Opis\Database\Database;
use Opis\Database\Connection;

$connection = new Connection('mysql:host=localhost;dbname=test', 'username', 'password');
$db = new Database($connection);

$result = $db-&gt;transaction(function(Database $db){
    
    $db-&gt;insert(['user' =&gt; 'John Doe', 'email' =&gt; 'jd@foobar.com'])
       -&gt;into('users');
       
    return $db-&gt;getConnection()-&gt;pdo()-&gt;lastInsertId();
})
-&gt;execute();
</code></pre>
<h2 id="receiving-notifications">Receiving notifications</h2>
<p>You can receive notifications about transaction errors by using the <code>onError</code> method. 
The method accepts as an argument an anonymous function which will be called if an error occurs. 
The arguments passed to the callback function are the current instance of the <code>Opis\Database\Transaction</code> 
class and the instance of the <code>PDOException</code> class that was thrown as an exception.</p><pre><code class="language-php">use PDOException;
use Opis\Database\Transaction;

// ...

$result = $db-&gt;transaction(function(Database $db){
    
    $db-&gt;insert(['user' =&gt; 'John Doe', 'email' =&gt; 'jd@foobar.com'])
       -&gt;into('users');
       
    return $db-&gt;getConnection()-&gt;pdo()-&gt;lastInsertId();
})
-&gt;onError(function(PDOException $exception, Transaction $transaction){
    // code here
})
-&gt;execute();
</code></pre>
<p>Receiving notifications about successful transaction is done by using the <code>onSuccess</code> method. 
The method accepts as an argument an anonymous callback function that will be called if the transaction succeeds.
The arguments passed to the callback function is the current instance of the <code>Opis\Database\Transaction</code> class.</p><pre><code class="language-php">use PDOException;
use Opis\Database\Transaction;

// ...

$result = $db-&gt;transaction(function(Database $db){
    
    $db-&gt;insert(['user' =&gt; 'John Doe', 'email' =&gt; 'jd@foobar.com'])
       -&gt;into('users');
       
    return $db-&gt;getConnection()-&gt;pdo()-&gt;lastInsertId();
})
-&gt;onSuccess(function(Transaction $transaction){
    // code here
})
-&gt;execute();
</code></pre>
<h2 id="ctrling-transaction-s-flow">Controlling transaction’s flow</h2>
<p>You can control in slight details how a transaction will be executed by passing 
an anonymous function as an argument to the <code>execute</code> method. 
The anonymous function will receive as an argument the current instance of the 
<code>Opis\Database\Transaction</code> and the closure that was passed to the transaction method.</p><pre><code class="language-php">use Closure;
use Opis\Database\Transaction;

// ...

$result = $db-&gt;transaction(function(Database $db){
    
    $db-&gt;insert(['user' =&gt; 'John Doe', 'email' =&gt; 'jd@foobar.com'])
       -&gt;into('users');
       
    return $db-&gt;getConnection()-&gt;pdo()-&gt;lastInsertId();
})
-&gt;execute(function(Transaction $transaction, Closure $callback){
    // ...
});
</code></pre>
<p>The <code>Opis\Database\Transaction</code> class offers a series of method that can be used to control 
how a transaction will be performed.</p>
<p>Starting a transaction is done by using the <code>begin</code> method. 
Committing a transaction is done by using the <code>commit</code> method, and rolling back 
a transaction is done by using the <code>rollBack</code> method.</p>
<p>You can obtain the instance of <code>Opis\Database\Database</code> class used for the ongoing transaction 
by calling the <code>database</code> method. 
You also have access to the underlying <code>PDO</code> object by calling the <code>pdo</code> method.</p><pre><code class="language-php">use Closure;
use PDOException;
use Opis\Database\Transaction;

// ...

$result = $db-&gt;transaction(function(Database $db){
    
    $db-&gt;insert(['user' =&gt; 'John Doe', 'email' =&gt; 'jd@foobar.com'])
       -&gt;into('users');
       
    return $db-&gt;getConnection()-&gt;pdo()-&gt;lastInsertId();
})
-&gt;execute(function(Transaction $transaction, Closure $callback){
    
    try
    {
        // Begin the transaction
        $transaction-&gt;begin();
        // Execute the callback
        $result = $callback($transaction-&gt;database());
        // Commit the transaction
        $transaction-&gt;commit();
        // Return the result of the transaction
        return $result;
    }
    catch(PDOException $e)
    {
        // Rollback the transaction
        $transaction-&gt;rollBack();
    }
    
});
</code></pre>
<p>You can get the success and error callbacks by using the <code>getOnSuccessCallback</code> and <code>getOnErrorCallback</code> methods.</p><pre><code class="language-php">use Closure;
use PDOException;
use Opis\Database\Transaction;

// ...

$result = $db-&gt;transaction(function(Database $db){
    
    $db-&gt;insert(['user' =&gt; 'John Doe', 'email' =&gt; 'jd@foobar.com'])
       -&gt;into('users');
       
    return $db-&gt;getConnection()-&gt;pdo()-&gt;lastInsertId();
})
-&gt;execute(function(Transaction $transaction, Closure $callback){
    
    try
    {
        // Begin the transaction
        $transaction-&gt;begin();
        // Execute the callback
        $result = $callback($transaction-&gt;database());
        // Commit the transaction
        $transaction-&gt;commit();
        // Get the success callback
        if(null !== $success = $transaction-&gt;getOnSuccessCallback())
        {
            $success($transaction);
        }
        // Return the result of the transaction
        return $result;
    }
    catch(PDOException $e)
    {
        // Rollback the transaction
        $transaction-&gt;rollBack();
        // Get the error callback
        if(null !== $error = $transaction-&gt;getOnErrorCallback())
        {
            $error($e, $transaction);
        }
    }
    
});
</code></pre>
<ul class="pager">
        <li class="previous"><a href="/database/3.6/delete-records" title="Delete records">&larr; Back</a></li>
        <li class="next"><a href="/database/3.6/schema" title="Introduction">Next &rarr;</a></li>
</ul>
                </div>
            </div>
        </div>
    </section>
    <a href="#0" id="back-to-top">
    <span class="fa fa-arrow-up"></span>
</a>
<script>
    (function($){
        $(document).ready(function(){
            var visible = false;
            $(window).scroll(function(){
                var top = $(this).scrollTop();
                if (top >= 100 && !visible) {
                    visible = true;
                    $('#back-to-top').fadeIn().show();
                }
                if(top < 100 && visible){
                    visible = false;
                    $('#back-to-top').fadeOut();
                }
            });
            $('#back-to-top').click(function(){
                $('html, body').animate({scrollTop : 0},800);
                return false;
            });
        });
        $('h2[id],h3[id],h4[id],h5[id],h6[id]').each(function () {
            var child = $('<a href="#' + this.getAttribute('id') + '" class="link-anchor"><span class="fa fa-link"></span></a>');
            this.appendChild(child.get(0));
        });
        $('[data-toggle=tooltip]').tooltip();
    })(jQuery);
</script>
    <footer class="text-center text-muted">
        Copyright &copy; 2014-2016 The Opis Project. All rights reserved.
    </footer>
</body>
</html>
